import{C as at,D as nt,G as rt,H as lt,b as J,c as I,e as U,f as W,g as Y,i as A,m as K,n as Q,o as X,s as Z,u as tt,v as et,w as it}from"./chunk-SV7ND62C.js";import{ga as ot,ja as st,ka as dt,la as mt,ma as ut}from"./chunk-SYYZOLA4.js";import{a as z,b as H}from"./chunk-HZIK2TNL.js";import{Bb as B,Cb as R,Db as b,Eb as u,Fb as m,Lb as q,Pb as f,Rb as c,Ua as d,V as k,Z as T,a as F,b as O,bb as $,da as x,dc as p,ea as C,ec as v,hb as N,la as L,n as G,r as g,va as P,x as V,xb as h,yb as w,zb as j}from"./chunk-QXPTUTPQ.js";function _t(a,e){if(a&1&&(u(0,"mat-error"),p(1),m()),a&2){let t=c(2);d(),v(t.ts.t("admin.availStartRequired"))}}function ft(a,e){if(a&1&&(u(0,"mat-error"),p(1),m()),a&2){let t=c(2);d(),v(t.ts.t("admin.availStartInvalid"))}}function yt(a,e){if(a&1&&(u(0,"mat-error"),p(1),m()),a&2){let t=c(2);d(),v(t.ts.t("admin.availStartInPast"))}}function gt(a,e){if(a&1&&(u(0,"mat-error"),p(1),m()),a&2){let t=c(2);d(),v(t.ts.t("admin.availEndInvalid"))}}function xt(a,e){if(a&1&&(u(0,"mat-error"),p(1),m()),a&2){let t=c(2);d(),v(t.ts.t("admin.availEndAfterStart"))}}function Ct(a,e){if(a&1&&(u(0,"mat-error"),p(1),m()),a&2){let t=c(2);d(),v(t.ts.t("admin.availMinDuration"))}}function ht(a,e){if(a&1&&(u(0,"mat-error"),p(1),m()),a&2){let t=c(2);d(),v(t.ts.t("admin.availDescWhitespace"))}}function wt(a,e){if(a&1&&(u(0,"div",12),p(1),m()),a&2){let t=c(2);d(),v(t.ts.t("admin.availOverlap"))}}function At(a,e){if(a&1){let t=q();u(0,"div",4)(1,"mat-form-field",5)(2,"mat-label"),p(3),m(),u(4,"input",6),f("change",function(){let n=x(t).$implicit,s=c();return C(s.onStartChange(s.asGroup(n)))}),m(),h(5,_t,2,1,"mat-error")(6,ft,2,1,"mat-error")(7,yt,2,1,"mat-error"),m(),u(8,"mat-form-field",7)(9,"mat-label"),p(10),m(),u(11,"input",8),f("change",function(){x(t);let n=c();return C(n.onFieldChange())}),m(),h(12,gt,2,1,"mat-error")(13,xt,2,1,"mat-error")(14,Ct,2,1,"mat-error"),m(),u(15,"mat-form-field",9)(16,"mat-label"),p(17),m(),u(18,"input",10),f("input",function(){x(t);let n=c();return C(n.onFieldChange())}),m(),h(19,ht,2,1,"mat-error"),m(),u(20,"button",11),f("click",function(){let n=x(t).$index,s=c();return C(s.removeRow(n))}),u(21,"mat-icon"),p(22,"delete"),m()(),h(23,wt,2,1,"div",12),m()}if(a&2){let t,i,n,s,l=e.$implicit,r=c();b("formGroup",r.asGroup(l)),d(3),v(r.ts.t("admin.availStartAt")),d(),b("disabled",r.disabled),d(),w(!((t=r.asGroup(l).get("start_at"))==null||t.errors==null)&&t.errors.required&&((t=r.asGroup(l).get("start_at"))!=null&&t.dirty)?5:!((t=r.asGroup(l).get("start_at"))==null||t.errors==null)&&t.errors.invalidDate&&((t=r.asGroup(l).get("start_at"))!=null&&t.dirty)?6:!((t=r.asGroup(l).get("start_at"))==null||t.errors==null)&&t.errors.startInPast&&((t=r.asGroup(l).get("start_at"))!=null&&t.dirty)?7:-1),d(5),v(r.ts.t("admin.availEndAt")),d(),b("disabled",r.disabled),d(),w(!((i=r.asGroup(l).get("end_at"))==null||i.errors==null)&&i.errors.invalidDate&&((i=r.asGroup(l).get("end_at"))!=null&&i.dirty)?12:!((i=r.asGroup(l).get("end_at"))==null||i.errors==null)&&i.errors.endBeforeStart&&((i=r.asGroup(l).get("end_at"))!=null&&i.dirty)?13:!((i=r.asGroup(l).get("end_at"))==null||i.errors==null)&&i.errors.minDuration&&((i=r.asGroup(l).get("end_at"))!=null&&i.dirty)?14:-1),d(5),v(r.ts.t("admin.availDesc")),d(),b("disabled",r.disabled),d(),w(!((n=r.asGroup(l).get("description"))==null||n.errors==null)&&n.errors.pattern&&((n=r.asGroup(l).get("description"))!=null&&n.dirty)?19:-1),d(),b("disabled",r.disabled),d(3),w((s=r.asGroup(l).errors)!=null&&s.overlap&&r.asGroup(l).dirty?23:-1)}}function D(a){let e=new Date(a);return!isNaN(e.getTime())}function Et(a){if(!a.value)return null;if(!D(a.value))return{invalidDate:!0};let e=new Date;return e.setSeconds(0,0),new Date(a.value)<e?{startInPast:!0}:null}function St(a){return e=>{if(!e.value)return null;if(!D(e.value))return{invalidDate:!0};let t=a();if(!t)return null;let i=t.get("start_at")?.value;if(!i)return null;let n=new Date(i),s=new Date(e.value);return s<=n?{endBeforeStart:!0}:s.getTime()-n.getTime()<3600*1e3?{minDuration:!0}:null}}function Ft(a){let e=a.controls;e.forEach(s=>{let l=F({},s.errors);delete l.overlap,s.setErrors(Object.keys(l).length?l:null)});let t=1/0,i=s=>s&&D(s)?new Date(s).getTime():null,n=!1;for(let s=0;s<e.length;s++)for(let l=s+1;l<e.length;l++){let r=e[s],_=e[l],E=i(r.get("start_at")?.value),M=i(r.get("end_at")?.value)??t,y=i(_.get("start_at")?.value),o=i(_.get("end_at")?.value)??t;E===null||y===null||E<o&&y<M&&(r.setErrors(O(F({},r.errors??{}),{overlap:!0})),_.setErrors(O(F({},_.errors??{}),{overlap:!0})),n=!0)}return n?{overlap:!0}:null}var pt=class a{constructor(e){this.ts=e}availabilities=[];disabled=!1;availabilitiesChange=new L;rows=new K([],{validators:Ft});ngOnChanges(e){if(e.availabilities){let t=e.availabilities.previousValue??[],i=e.availabilities.currentValue??[],n=t.map(l=>l.id).filter(Boolean).sort().join(","),s=i.map(l=>l.id).filter(Boolean).sort().join(",");if(n!==s){this.rows.clear();for(let l of i)this.rows.push(this.buildRow(l))}}}buildRow(e){let t=new Y({id:new A(e?.id),start_at:new A(e?this.toDatetimeLocal(e.start_at):"",[I.required,Et]),end_at:new A(e?.end_at?this.toDatetimeLocal(e.end_at):""),description:new A(e?.description??"",[I.maxLength(255),I.pattern(/.*\S.*/)])});return t.get("end_at").addValidators(St(()=>t)),t}addRow(){this.rows.push(this.buildRow()),this.emit()}removeRow(e){this.rows.removeAt(e),this.emit()}onStartChange(e){e.get("end_at")?.updateValueAndValidity(),this.rows.updateValueAndValidity(),this.emit()}onFieldChange(){this.rows.updateValueAndValidity(),this.emit()}asGroup(e){return e}emit(){let e=this.rows.controls.map(t=>{let n=t.value;return{id:n.id??void 0,start_at:n.start_at?new Date(n.start_at).toISOString():"",end_at:n.end_at?new Date(n.end_at).toISOString():null,description:n.description||null}});this.availabilitiesChange.emit(e)}toDatetimeLocal(e){if(!e)return"";let t=new Date(e),i=n=>String(n).padStart(2,"0");return`${t.getFullYear()}-${i(t.getMonth()+1)}-${i(t.getDate())}T${i(t.getHours())}:${i(t.getMinutes())}`}markAllDirty(){this.rows.controls.forEach(e=>{e.markAsDirty(),Object.values(e.controls).forEach(t=>t.markAsDirty()),e.updateValueAndValidity()}),this.rows.updateValueAndValidity()}get isValid(){return this.rows.valid}static \u0275fac=function(t){return new(t||a)($(z))};static \u0275cmp=N({type:a,selectors:[["app-availability-list"]],inputs:{availabilities:"availabilities",disabled:"disabled"},outputs:{availabilitiesChange:"availabilitiesChange"},features:[P],decls:9,vars:2,consts:[[1,"avail-header"],[1,"avail-label"],["type","button","mat-mini-fab","",1,"btn-add-avail",3,"click","disabled"],[1,"avail-rows"],[1,"avail-row",3,"formGroup"],["appearance","outline",1,"avail-start"],["matInput","","type","datetime-local","formControlName","start_at",3,"change","disabled"],["appearance","outline",1,"avail-end"],["matInput","","type","datetime-local","formControlName","end_at",3,"change","disabled"],["appearance","outline",1,"avail-desc"],["matInput","","formControlName","description","maxlength","255",3,"input","disabled"],["type","button","mat-icon-button","",1,"btn-remove-avail",3,"click","disabled"],[1,"avail-overlap-error"]],template:function(t,i){t&1&&(u(0,"div",0)(1,"span",1),p(2),m(),u(3,"button",2),f("click",function(){return i.addRow()}),u(4,"mat-icon"),p(5,"add"),m()()(),u(6,"div",3),B(7,At,24,12,"div",4,j),m()),t&2&&(d(2),v(i.ts.t("admin.availabilities")),d(),b("disabled",i.disabled),d(4),R(i.rows.controls))},dependencies:[tt,J,U,W,Z,X,Q,dt,st,ot,ut,mt,nt,at,et,it,lt,rt],styles:[".avail-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;margin-top:1rem;margin-bottom:.5rem}.avail-label[_ngcontent-%COMP%]{font-size:.9rem;font-weight:600;color:var(--mat-sys-on-surface, #333)}.btn-add-avail[_ngcontent-%COMP%]{width:32px;height:32px;min-width:32px;line-height:32px;background-color:var(--mat-sys-primary, #c86d3f);color:var(--mat-sys-on-primary, #fff)}.btn-add-avail[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px;line-height:18px;width:18px;height:18px}.avail-rows[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem}.avail-row[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:.5rem;flex-wrap:wrap;background-color:var(--clay, #f3ede4);border-radius:8px;padding:.75rem .75rem 0}.avail-start[_ngcontent-%COMP%], .avail-end[_ngcontent-%COMP%]{flex:1 1 220px;min-width:210px}.avail-desc[_ngcontent-%COMP%]{flex:2 1 200px;min-width:160px}.btn-remove-avail[_ngcontent-%COMP%]{margin-top:.35rem;flex-shrink:0;color:#1b1a1773!important}.btn-remove-avail[_ngcontent-%COMP%]:hover{color:var(--rust, #8a3f24)!important}.avail-overlap-error[_ngcontent-%COMP%]{width:100%;font-size:.75rem;color:var(--mat-sys-error, #b00020);padding:0 .25rem .5rem}"]})};var ct=class a{constructor(e){this.api=e}base(e,t){return`/api/${e}/${t}/availabilities`}getAvailabilities(e,t){return this.api.get(this.base(e,t)).pipe(g(i=>i.data))}createAvailability(e,t,i){return this.api.post(this.base(e,t),{availability:i}).pipe(g(n=>n.data))}updateAvailability(e,t,i,n){return this.api.put(`${this.base(e,t)}/${i}`,{availability:n}).pipe(g(s=>s.data))}deleteAvailability(e,t,i){return this.api.delete(`${this.base(e,t)}/${i}`).pipe(g(()=>{}))}syncAvailabilities(e,t,i,n,s){let l=e.filter(o=>!o.id),r=o=>o?new Date(o).getTime():null,_=e.filter(o=>{if(!o.id)return!1;let S=t.find(vt=>vt.id===o.id);return S?r(S.start_at)!==r(o.start_at)||r(S.end_at)!==r(o.end_at)||(S.description??null)!==(o.description??null):!1}),E=new Set(e.filter(o=>o.id).map(o=>o.id)),M=t.filter(o=>!E.has(o.id)),y=[...l.map(o=>i({start_at:o.start_at,end_at:o.end_at,description:o.description})),..._.map(o=>n(o.id,{start_at:o.start_at,end_at:o.end_at,description:o.description})),...M.map(o=>s(o.id))];return y.length>0?V(y):G(null)}static \u0275fac=function(t){return new(t||a)(T(H))};static \u0275prov=k({token:a,factory:a.\u0275fac,providedIn:"root"})};export{pt as a,ct as b};
