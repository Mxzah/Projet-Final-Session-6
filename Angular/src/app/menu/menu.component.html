<app-header
  [showLogout]="authService.isAuthenticated()"
  [showLogin]="!authService.isAuthenticated()"
  (logoutClick)="logout()"
  (loginClick)="goToLogin()">
  @if (authService.isAdmin()) {
    <span class="header-divider">|</span>
    <button mat-button class="admin-btn" (click)="goToAdmin()">
      <mat-icon>admin_panel_settings</mat-icon>
      {{ ts.t('header.admin') }}
    </button>
  }
  <span class="header-divider">|</span>
  <div class="cart-display cart-header" (click)="toggleCart()">
    <div class="cart-icon-wrap">
      <mat-icon [matBadge]="cartService.totalItems()" matBadgeSize="small" matBadgeColor="warn">shopping_cart</mat-icon>
    </div>
    <div class="cart-text">
      <span class="cart-label">{{ ts.t('menu.subtotal') }}</span>
      <span class="cart-price">CA${{ cartService.subtotal().toFixed(2) }}</span>
    </div>
  </div>
</app-header>

<mat-toolbar class="cart-bottom-bar">
  <mat-icon>shopping_cart</mat-icon>
  <span class="cart-bottom-text">{{ cartService.totalItems() }} {{ ts.t('menu.item') }} &bull; CA${{ cartService.subtotal().toFixed(2) }}</span>
  <mat-icon>chevron_right</mat-icon>
</mat-toolbar>

<main class="menu-page">
  @if (isLoading()) {
    <div class="loading">
      <mat-spinner diameter="48"></mat-spinner>
    </div>
  } @else if (errorMessage()) {
    <mat-card class="error-banner">
      <mat-card-content>
        <p>{{ errorMessage() }}</p>
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="menu-layout" [class.menu-layout-cart-open]="cartOpen()">
      <aside class="sidebar">
        <h2 class="sidebar-title">{{ ts.t('menu.categories') }}</h2>
        <mat-nav-list class="category-nav">
          @for (cat of categories(); track cat.id) {
            <mat-list-item
              class="category-btn"
              [class.active]="cat.id === activeCategory()"
              (click)="selectCategory(cat.id)"
            >
              <span matListItemTitle>{{ cat.name }}</span>
            </mat-list-item>
          }
        </mat-nav-list>
      </aside>

      <section class="menu-content">
        <mat-toolbar class="ssf-bar">
          <mat-form-field class="ssf-search" appearance="outline">
            <mat-label>{{ ts.t('menu.search') }}</mat-label>
            <input matInput type="text" (input)="onSearchInput($event)" />
            <mat-icon matPrefix>search</mat-icon>
          </mat-form-field>

          <div class="ssf-filter">
            <mat-form-field appearance="outline">
              <mat-label>{{ ts.t('menu.priceMin') }}</mat-label>
              <input matInput type="number" min="0" step="0.01" (input)="onPriceMinChange($event)" />
            </mat-form-field>
            <span class="ssf-separator">—</span>
            <mat-form-field appearance="outline">
              <mat-label>{{ ts.t('menu.priceMax') }}</mat-label>
              <input matInput type="number" min="0" step="0.01" (input)="onPriceMaxChange($event)" />
            </mat-form-field>
          </div>

          <mat-form-field class="ssf-sort" appearance="outline">
            <mat-label>{{ ts.t('menu.sortByPrice') }}</mat-label>
            <mat-select (selectionChange)="onSortChange($event.value)">
              <mat-option value="none">{{ ts.t('menu.sortByPrice') }}</mat-option>
              <mat-option value="asc">{{ ts.t('menu.priceAsc') }}</mat-option>
              <mat-option value="desc">{{ ts.t('menu.priceDesc') }}</mat-option>
            </mat-select>
          </mat-form-field>
        </mat-toolbar>

        <div class="mobile-category-select">
          <mat-form-field appearance="outline" class="mobile-cat-field">
            <mat-label>{{ ts.t('menu.category') }}</mat-label>
            <mat-select [value]="activeCategory()" (selectionChange)="onMobileCategoryChange($event.value)">
              @for (cat of categories(); track cat.id) {
                <mat-option [value]="cat.id">{{ cat.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        @if (allItems().length === 0) {
          <div class="no-results">
            <mat-icon class="no-results-icon">search_off</mat-icon>
            <p class="no-results-text">{{ ts.t('menu.noResults') }}</p>
          </div>
        } @else {
          @for (group of itemsByCategory(); track group.id) {
            @if (group.items.length > 0) {
            <div class="category-section" [id]="'category-' + group.id">
              <h1 class="category-heading">{{ group.name }}</h1>

              <div class="items-grid">
                @for (item of group.items; track item.id) {
                  <mat-card class="menu-card" (click)="openItemModal(item)">
                    <mat-card-content class="card-content-row">
                      <div class="card-info">
                        <mat-card-title class="card-name">{{ item.name }}</mat-card-title>
                        <mat-card-subtitle class="card-description">{{ item.description }}</mat-card-subtitle>
                        <span class="card-price">CA${{ item.price.toFixed(2) }}</span>
                      </div>
                      <div class="card-right">
                        <div class="card-image">
                          <img [src]="item.image_url" [alt]="item.name" loading="lazy" />
                        </div>
                        <button mat-mini-fab class="add-btn" [attr.aria-label]="'Ajouter ' + item.name">
                          <mat-icon>add</mat-icon>
                        </button>
                      </div>
                    </mat-card-content>
                  </mat-card>
                } @empty {
                  <p class="no-items">{{ ts.t('menu.noItems') }}</p>
                }
              </div>
            </div>
            }
          }
        }
      </section>

      <!-- Cart sidebar -->
      <aside class="cart-sidebar" [class.cart-sidebar-open]="cartOpen()">
        <mat-toolbar class="cart-sidebar-header">
          <button mat-icon-button class="cart-sidebar-close" (click)="toggleCart()">
            <mat-icon>close</mat-icon>
          </button>
          <h2 class="cart-sidebar-title">{{ ts.t('menu.yourOrder') }}</h2>
        </mat-toolbar>

        <div class="cart-sidebar-lines">
          @for (line of cartService.lines(); track $index) {
            <mat-card class="cart-line">
              <mat-card-content>
                <mat-card-title class="cart-line-name">{{ line.name }}</mat-card-title>
                <mat-card-subtitle class="cart-line-meta">CA${{ line.unit_price.toFixed(2) }} {{ ts.t('menu.unit') }} &middot; <span class="cart-line-qty">{{ line.quantity }} {{ line.quantity > 1 ? ts.t('menu.portions') : ts.t('menu.portion') }}</span></mat-card-subtitle>
                <div class="cart-line-total">
                  <span class="cart-line-total-label">TOTAL</span>
                  <span class="cart-line-total-price">CA${{ (line.unit_price * line.quantity).toFixed(2) }}</span>
                </div>
                <mat-card-actions class="cart-line-actions">
                  <button mat-stroked-button class="btn-cart-edit" (click)="$event.stopPropagation()">{{ ts.t('menu.modify') }}</button>
                  <button mat-stroked-button color="warn" class="btn-cart-remove" (click)="$event.stopPropagation()">{{ ts.t('menu.remove') }}</button>
                </mat-card-actions>
              </mat-card-content>
            </mat-card>
          } @empty {
            <p class="cart-empty">{{ ts.t('menu.cartEmpty') }}</p>
          }
        </div>

        <mat-divider></mat-divider>

        <div class="cart-sidebar-footer">
          <div class="cart-subtotal">
            <span>{{ ts.t('menu.subtotal') }}</span>
            <span class="cart-subtotal-price">CA${{ cartService.subtotal().toFixed(2) }}</span>
          </div>
          <button mat-flat-button class="btn-continue" [disabled]="cartService.totalItems() === 0" (click)="goToOrder()">{{ ts.t('menu.continue') }}</button>
        </div>
      </aside>
    </div>
  }
</main>

<!-- Modal -->
@if (selectedItem()) {
  <div class="modal-overlay" (click)="onOverlayClick($event)">
    <mat-card class="modal">
      <button mat-icon-button class="modal-close" (click)="closeModal()">
        <mat-icon>close</mat-icon>
      </button>

      <mat-card-content class="modal-body">
        <div class="modal-image">
          <img [src]="selectedItem()!.image_url" [alt]="selectedItem()!.name" />
        </div>

        <mat-card-header class="modal-details">
          <mat-card-title class="modal-name">{{ selectedItem()!.name }}</mat-card-title>
          <mat-card-subtitle class="modal-description">{{ selectedItem()!.description }}</mat-card-subtitle>
        </mat-card-header>

        <div class="modal-price-box">
          <span class="modal-price-label">{{ ts.t('menu.fromPrice') }}</span>
          <span class="modal-price">CA${{ selectedItem()!.price.toFixed(2) }}</span>
        </div>

        <div class="modal-note-section">
          <mat-form-field appearance="outline" class="modal-note-field">
            <mat-label>{{ ts.t('menu.specialInstructions') }}</mat-label>
            <textarea
              matInput
              [placeholder]="ts.t('menu.specialPlaceholder')"
              maxlength="255"
              [value]="modalNote()"
              (input)="onNoteInput($event)"
              rows="3"
            ></textarea>
            <mat-hint align="end">{{ modalNote().length }}/255</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>

      <mat-card-actions class="modal-footer">
        <div class="modal-quantity">
          <button mat-icon-button class="qty-btn" (click)="decrementQuantity()" [disabled]="modalQuantity() <= 1">
            <mat-icon>remove</mat-icon>
          </button>
          <span class="qty-value">{{ modalQuantity() }}</span>
          <button mat-icon-button class="qty-btn" (click)="incrementQuantity()" [disabled]="modalQuantity() >= 50">
            <mat-icon>add</mat-icon>
          </button>
        </div>
        <button mat-flat-button class="modal-add-btn" (click)="addToCart()">
          {{ ts.t('menu.addToCart') }} — CA${{ modalTotal().toFixed(2) }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
}
