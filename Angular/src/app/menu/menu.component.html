<app-header (logoutClick)="logout()">
  <span class="header-divider">|</span>
  <div class="cart-display cart-header" (click)="toggleCart()">
    <div class="cart-icon-wrap">
      <mat-icon [matBadge]="cartService.totalItems()" matBadgeSize="small" matBadgeColor="warn">shopping_cart</mat-icon>
    </div>
    <div class="cart-text">
      <span class="cart-label">Sous-total</span>
      <span class="cart-price">CA${{ cartService.subtotal().toFixed(2) }}</span>
    </div>
  </div>
</app-header>

<mat-toolbar class="cart-bottom-bar">
  <mat-icon>shopping_cart</mat-icon>
  <span class="cart-bottom-text">{{ cartService.totalItems() }} item(s) &bull; CA${{ cartService.subtotal().toFixed(2) }}</span>
  <mat-icon>chevron_right</mat-icon>
</mat-toolbar>

<main class="menu-page">
  @if (isLoading()) {
    <div class="loading">
      <mat-spinner diameter="48"></mat-spinner>
    </div>
  } @else if (errorMessage()) {
    <mat-card class="error-banner">
      <mat-card-content>
        <p>{{ errorMessage() }}</p>
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="menu-layout" [class.menu-layout-cart-open]="cartOpen()">
      <aside class="sidebar">
        <h2 class="sidebar-title">Catégories</h2>
        <mat-nav-list class="category-nav">
          @for (cat of categories(); track cat.id) {
            <mat-list-item
              class="category-btn"
              [class.active]="cat.id === activeCategory()"
              (click)="selectCategory(cat.id)"
            >
              <span matListItemTitle>{{ cat.name }}</span>
            </mat-list-item>
          }
        </mat-nav-list>
      </aside>

      <section class="menu-content">
        <mat-toolbar class="ssf-bar">
          <mat-form-field class="ssf-search" appearance="outline">
            <mat-label>Rechercher un item...</mat-label>
            <input matInput type="text" (input)="onSearchInput($event)" />
            <mat-icon matPrefix>search</mat-icon>
          </mat-form-field>

          <div class="ssf-filter">
            <mat-form-field appearance="outline">
              <mat-label>Prix min</mat-label>
              <input matInput type="number" min="0" step="0.01" (input)="onPriceMinChange($event)" />
            </mat-form-field>
            <span class="ssf-separator">—</span>
            <mat-form-field appearance="outline">
              <mat-label>Prix max</mat-label>
              <input matInput type="number" min="0" step="0.01" (input)="onPriceMaxChange($event)" />
            </mat-form-field>
          </div>

          <mat-form-field class="ssf-sort" appearance="outline">
            <mat-label>Trier par prix</mat-label>
            <mat-select (selectionChange)="onSortChange($event.value)">
              <mat-option value="none">Trier par prix</mat-option>
              <mat-option value="asc">Prix croissant</mat-option>
              <mat-option value="desc">Prix décroissant</mat-option>
            </mat-select>
          </mat-form-field>
        </mat-toolbar>

        <div class="mobile-category-select">
          <mat-form-field appearance="outline" class="mobile-cat-field">
            <mat-label>Catégorie</mat-label>
            <mat-select [value]="activeCategory()" (selectionChange)="onMobileCategoryChange($event.value)">
              @for (cat of categories(); track cat.id) {
                <mat-option [value]="cat.id">{{ cat.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        @for (group of itemsByCategory(); track group.id) {
          @if (group.items.length > 0) {
          <div class="category-section" [id]="'category-' + group.id">
            <h1 class="category-heading">{{ group.name }}</h1>

            <div class="items-grid">
              @for (item of group.items; track item.id) {
                <mat-card class="menu-card" (click)="openItemModal(item)">
                  <mat-card-content class="card-content-row">
                    <div class="card-info">
                      <mat-card-title class="card-name">{{ item.name }}</mat-card-title>
                      <mat-card-subtitle class="card-description">{{ item.description }}</mat-card-subtitle>
                      <span class="card-price">CA${{ item.price.toFixed(2) }}</span>
                    </div>
                    <div class="card-right">
                      <div class="card-image">
                        <img [src]="item.image_url" [alt]="item.name" loading="lazy" />
                      </div>
                      <button mat-mini-fab class="add-btn" [attr.aria-label]="'Ajouter ' + item.name">
                        <mat-icon>add</mat-icon>
                      </button>
                    </div>
                  </mat-card-content>
                </mat-card>
              } @empty {
                <p class="no-items">Aucun item dans cette catégorie.</p>
              }
            </div>
          </div>
          }
        }
      </section>

      <!-- Cart sidebar -->
      <aside class="cart-sidebar" [class.cart-sidebar-open]="cartOpen()">
        <mat-toolbar class="cart-sidebar-header">
          <button mat-icon-button class="cart-sidebar-close" (click)="toggleCart()">
            <mat-icon>close</mat-icon>
          </button>
          <h2 class="cart-sidebar-title">Votre commande</h2>
        </mat-toolbar>

        <div class="cart-sidebar-lines">
          @for (line of cartService.lines(); track $index) {
            <mat-card class="cart-line">
              <mat-card-content>
                <mat-card-title class="cart-line-name">{{ line.name }}</mat-card-title>
                <mat-card-subtitle class="cart-line-meta">CA${{ line.unit_price.toFixed(2) }} / unit &middot; <span class="cart-line-qty">{{ line.quantity }} portion{{ line.quantity > 1 ? 's' : '' }}</span></mat-card-subtitle>
                <div class="cart-line-total">
                  <span class="cart-line-total-label">TOTAL</span>
                  <span class="cart-line-total-price">CA${{ (line.unit_price * line.quantity).toFixed(2) }}</span>
                </div>
                <mat-card-actions class="cart-line-actions">
                  <button mat-stroked-button class="btn-cart-edit" (click)="$event.stopPropagation()">Modifier</button>
                  <button mat-stroked-button color="warn" class="btn-cart-remove" (click)="$event.stopPropagation()">Retirer</button>
                </mat-card-actions>
              </mat-card-content>
            </mat-card>
          } @empty {
            <p class="cart-empty">Votre panier est vide.</p>
          }
        </div>

        <mat-divider></mat-divider>

        <div class="cart-sidebar-footer">
          <div class="cart-subtotal">
            <span>Sous-total</span>
            <span class="cart-subtotal-price">CA${{ cartService.subtotal().toFixed(2) }}</span>
          </div>
          <button mat-flat-button class="btn-continue" [disabled]="cartService.totalItems() === 0" (click)="goToOrder()">Continuer</button>
        </div>
      </aside>
    </div>
  }
</main>

<!-- Modal -->
@if (selectedItem()) {
  <div class="modal-overlay" (click)="onOverlayClick($event)">
    <mat-card class="modal">
      <button mat-icon-button class="modal-close" (click)="closeModal()">
        <mat-icon>close</mat-icon>
      </button>

      <mat-card-content class="modal-body">
        <div class="modal-image">
          <img [src]="selectedItem()!.image_url" [alt]="selectedItem()!.name" />
        </div>

        <mat-card-header class="modal-details">
          <mat-card-title class="modal-name">{{ selectedItem()!.name }}</mat-card-title>
          <mat-card-subtitle class="modal-description">{{ selectedItem()!.description }}</mat-card-subtitle>
        </mat-card-header>

        <div class="modal-price-box">
          <span class="modal-price-label">À PARTIR DE</span>
          <span class="modal-price">CA${{ selectedItem()!.price.toFixed(2) }}</span>
          <span class="modal-price-note">Le prix peut varier selon les options.</span>
        </div>

        <div class="modal-note-section">
          <mat-form-field appearance="outline" class="modal-note-field">
            <mat-label>Instructions spéciales (optionnel)</mat-label>
            <textarea
              matInput
              placeholder="Ex: Sans oignon, extra sauce, bien cuit..."
              maxlength="255"
              [value]="modalNote()"
              (input)="onNoteInput($event)"
              rows="3"
            ></textarea>
            <mat-hint align="end">{{ modalNote().length }}/255</mat-hint>
          </mat-form-field>
        </div>
      </mat-card-content>

      <mat-card-actions class="modal-footer">
        <div class="modal-quantity">
          <button mat-icon-button class="qty-btn" (click)="decrementQuantity()" [disabled]="modalQuantity() <= 1">
            <mat-icon>remove</mat-icon>
          </button>
          <span class="qty-value">{{ modalQuantity() }}</span>
          <button mat-icon-button class="qty-btn" (click)="incrementQuantity()">
            <mat-icon>add</mat-icon>
          </button>
        </div>
        <button mat-flat-button class="modal-add-btn" (click)="addToCart()">
          Ajouter au panier — CA${{ modalTotal().toFixed(2) }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
}
