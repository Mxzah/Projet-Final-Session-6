<main class="page-admin">
  <div class="outer-container">
    <div class="welcome-header">
      <h2 class="welcome-title">
        {{ ts.t('admin.itemsTitle') }}
        <button mat-mini-fab class="btn-add" [title]="ts.t('admin.addItem')" (click)="openCreate()">
          <mat-icon>add</mat-icon>
        </button>
      </h2>
      <p class="welcome-text">{{ ts.t('admin.itemsSubtitle') }}</p>
    </div>

    @if (isLoading()) {
      <div class="loading">
        <mat-spinner diameter="48"></mat-spinner>
      </div>
    }

    @if (!isLoading() && items().length === 0) {
      <div class="empty">{{ ts.t('admin.noItems') }}</div>
    }

    @if (!isLoading() && items().length > 0) {
      <div class="items-grid">
        @for (item of items(); track item.id) {
          <mat-card class="item-card" [class.archived]="item.deleted_at">
            <div class="item-image">
              @if (item.image_url) {
                <img [src]="item.image_url" [alt]="item.name" />
              } @else {
                <div class="image-placeholder"></div>
              }
              @if (item.deleted_at) {
                <div class="archived-badge">{{ ts.t('admin.archived') }}</div>
              }
            </div>
            <mat-card-content class="item-body">
              <mat-card-title class="item-name">{{ item.name }}</mat-card-title>
              <mat-card-subtitle class="item-description">{{ item.description }}</mat-card-subtitle>
              <span class="item-category">{{ item.category_name ?? '—' }}</span>
              <span class="item-price">{{ item.price | number:'1.2-2' }} $</span>
            </mat-card-content>
            <mat-card-actions class="item-actions">
              @if (item.deleted_at) {
                <button mat-icon-button class="action-btn restore" [title]="ts.t('admin.restoreBtn')" (click)="confirmRestore(item)">
                  <mat-icon>unarchive</mat-icon>
                </button>
              } @else {
                <button mat-icon-button class="action-btn edit" [title]="ts.t('admin.editBtn')" (click)="openEdit(item)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button class="action-btn delete" [title]="ts.t('admin.deleteBtn')" (click)="confirmDelete(item)">
                  <mat-icon>delete</mat-icon>
                </button>
              }
            </mat-card-actions>
          </mat-card>
        }
      </div>
    }
  </div>
</main>

<!-- Modale de confirmation de suppression -->
@if (itemToDelete()) {
  <div class="modal-overlay">
    <mat-card class="modal">
      <div class="modal-delete-header">
        <span class="modal-title">{{ itemToDelete()!.in_use ? ts.t('admin.archiveItem') : ts.t('admin.deleteItem') }}</span>
        <button mat-icon-button class="modal-close" (click)="cancelDelete()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <mat-card-content>
        @if (itemToDelete()!.in_use) {
          <p class="modal-text">{{ ts.t('admin.archiveConfirm') }} <strong>{{ itemToDelete()!.name }}</strong> ?</p>
          <p class="modal-warning">{{ ts.t('admin.archiveWarning') }}</p>
        } @else {
          <p class="modal-text">{{ ts.t('admin.deleteConfirm') }} <strong>{{ itemToDelete()!.name }}</strong> ?</p>
        }
      </mat-card-content>
      <mat-card-actions class="modal-actions">
        <button mat-stroked-button class="btn-cancel" (click)="cancelDelete()">{{ ts.t('admin.cancel') }}</button>
        <button mat-flat-button class="btn-danger" (click)="deleteItem()">
          {{ itemToDelete()!.in_use ? ts.t('admin.archive') : ts.t('admin.delete') }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
}

<!-- Modale de confirmation de désarchivage -->
@if (itemToRestore()) {
  <div class="modal-overlay">
    <mat-card class="modal">
      <div class="modal-delete-header">
        <span class="modal-title">{{ ts.t('admin.restoreItem') }}</span>
        <button mat-icon-button class="modal-close" (click)="cancelRestore()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <mat-card-content>
        <p class="modal-text">{{ ts.t('admin.restoreConfirm') }} <strong>{{ itemToRestore()!.name }}</strong> ?</p>
      </mat-card-content>
      <mat-card-actions class="modal-actions">
        <button mat-stroked-button class="btn-cancel" (click)="cancelRestore()">{{ ts.t('admin.cancel') }}</button>
        <button mat-flat-button class="btn-restore" (click)="restoreItem()">{{ ts.t('admin.restoreBtn') }}</button>
      </mat-card-actions>
    </mat-card>
  </div>
}

<!-- Modale de création / modification -->
@if (editingItem() || isCreating()) {
  <div class="modal-overlay">
    <mat-card class="modal modal-edit">
      <div class="modal-edit-header">
        <span class="modal-title">{{ isCreating() ? ts.t('admin.addItem') : ts.t('admin.editItem') }}</span>
        <button mat-icon-button class="modal-close" (click)="cancelEdit()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="modal-edit-body">
        @if (editError()) {
          <div class="modal-error">{{ editError() }}</div>
        }

        <form id="editForm" [formGroup]="editForm" (ngSubmit)="isCreating() ? saveCreate() : saveEdit()">
          <mat-form-field appearance="outline" class="modal-field-full">
            <mat-label>{{ ts.t('admin.name') }}</mat-label>
            <input matInput formControlName="name" />
            @if (editForm.controls.name.dirty && editForm.controls.name.errors) {
              <mat-error>
                @if (editForm.controls.name.errors['required']) {
                  {{ ts.t('admin.nameRequired') }}
                } @else if (editForm.controls.name.errors['maxlength']) {
                  {{ ts.t('admin.nameMaxLength') }}
                } @else if (editForm.controls.name.errors['whitespace']) {
                  {{ ts.t('admin.nameWhitespace') }}
                }
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="modal-field-full">
            <mat-label>{{ ts.t('admin.description') }}</mat-label>
            <textarea matInput formControlName="description" rows="3"></textarea>
            @if (editForm.controls.description.dirty && editForm.controls.description.errors) {
              <mat-error>
                @if (editForm.controls.description.errors['maxlength']) {
                  {{ ts.t('admin.descMaxLength') }}
                } @else if (editForm.controls.description.errors['whitespace']) {
                  {{ ts.t('admin.descWhitespace') }}
                }
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="modal-field-full">
            <mat-label>{{ ts.t('admin.price') }}</mat-label>
            <input matInput type="number" formControlName="price" step="0.01" />
            @if (editForm.controls.price.dirty && editForm.controls.price.errors) {
              <mat-error>
                @if (editForm.controls.price.errors['required']) {
                  {{ ts.t('admin.priceRequired') }}
                } @else if (editForm.controls.price.errors['min']) {
                  {{ ts.t('admin.priceMin') }}
                } @else if (editForm.controls.price.errors['max']) {
                  {{ ts.t('admin.priceMax') }}
                }
              </mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="modal-field-full">
            <mat-label>{{ ts.t('admin.category') }}</mat-label>
            <mat-select formControlName="category_id">
              @for (cat of categories(); track cat.id) {
                <mat-option [value]="cat.id">{{ cat.name }}</mat-option>
              }
            </mat-select>
            @if (editForm.controls.category_id.dirty && editForm.controls.category_id.errors) {
              <mat-error>{{ ts.t('admin.categoryRequired') }}</mat-error>
            }
          </mat-form-field>

          <div class="modal-field">
            <label class="file-label">{{ ts.t('admin.image') }}</label>
            @if (editImagePreview()) {
              <div class="image-preview">
                <img [src]="editImagePreview()" alt="Aperçu" />
              </div>
            }
            <input #fileInput type="file" accept="image/jpeg,image/png" (change)="onImageSelected($event)" class="file-input-hidden" />
            <button type="button" class="file-btn" (click)="fileInput.click()">
              <mat-icon>upload</mat-icon>
              {{ ts.t('admin.chooseFile') }}
            </button>
            @if (editImageError()) {
              <mat-error class="file-error">{{ editImageError() }}</mat-error>
            }
          </div>

        </form>
      </div>
      <div class="modal-edit-footer">
        <button mat-stroked-button type="button" class="btn-cancel" (click)="cancelEdit()">{{ ts.t('admin.cancel') }}</button>
        <button mat-flat-button type="submit" form="editForm" class="btn-primary" [disabled]="editLoading() || editForm.invalid">
          {{ editLoading() ? ts.t('admin.saving') : (isCreating() ? ts.t('admin.add') : ts.t('admin.save')) }}
        </button>
      </div>
    </mat-card>
  </div>
}
