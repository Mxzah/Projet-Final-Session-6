<main class="page-admin">
  <div class="outer-container">
    <div class="welcome-header">
      <h2 class="welcome-title">Gestion des tables</h2>
      <p class="welcome-text">Cr√©ez des tables, personnalisez et t√©l√©chargez vos QR codes.</p>
    </div>

    <!-- QR Style Customization -->
    <section class="inner-container style-section">
      <h3>üé® Style des QR codes</h3>

      <div class="base-url-field">
        <label>üîó URL de base (pour les QR codes)</label>
        <input type="text" [(ngModel)]="baseUrl" (ngModelChange)="onBaseUrlChange()" placeholder="https://votre-url.ngrok-free.dev" />
        <small>Utilise l'URL ngrok pour que les QR fonctionnent sur mobile</small>
      </div>

      <div class="style-grid">
        <div class="style-field">
          <label>Motif des points</label>
          <select [(ngModel)]="qrDotType" (ngModelChange)="onStyleChange()">
            @for (dt of dotTypes; track dt) {
              <option [value]="dt">{{ dt }}</option>
            }
          </select>
        </div>
        <div class="style-field">
          <label>Couleur des points</label>
          <div class="color-row">
            <input type="color" [(ngModel)]="qrDotColor" (ngModelChange)="onStyleChange()" />
            <code>{{ qrDotColor }}</code>
          </div>
        </div>
        <div class="style-field">
          <label>Coins (carr√©)</label>
          <select [(ngModel)]="qrCornerSquareType" (ngModelChange)="onStyleChange()">
            @for (ct of cornerSquareTypes; track ct) {
              <option [value]="ct">{{ ct }}</option>
            }
          </select>
        </div>
        <div class="style-field">
          <label>Coins (point)</label>
          <select [(ngModel)]="qrCornerDotType" (ngModelChange)="onStyleChange()">
            @for (cdt of cornerDotTypes; track cdt) {
              <option [value]="cdt">{{ cdt }}</option>
            }
          </select>
        </div>
        <div class="style-field">
          <label>Couleur des coins</label>
          <div class="color-row">
            <input type="color" [(ngModel)]="qrCornerColor" (ngModelChange)="onStyleChange()" />
            <code>{{ qrCornerColor }}</code>
          </div>
        </div>
        <div class="style-field">
          <label>Couleur du fond</label>
          <div class="color-row">
            <input type="color" [(ngModel)]="qrBgColor" (ngModelChange)="onStyleChange()" />
            <code>{{ qrBgColor }}</code>
          </div>
        </div>
      </div>
    </section>

    <!-- Create new table -->
    <section class="inner-container create-section">
      <h3>+ Ajouter une table</h3>
      <form class="create-form" (ngSubmit)="createTable()">
        <div class="form-row">
          <div class="field">
            <label for="newNumber">Num√©ro</label>
            <input id="newNumber" type="number" min="1" placeholder="Ex: 11" [(ngModel)]="newTableNumber" name="number" required />
          </div>
          <div class="field">
            <label for="newCapacity">Capacit√©</label>
            <input id="newCapacity" type="number" min="1" max="20" [(ngModel)]="newTableCapacity" name="capacity" required />
          </div>
          <button type="submit" class="primary create-btn" [disabled]="isCreating || !newTableNumber">
            {{ isCreating ? '...' : 'Cr√©er' }}
          </button>
        </div>
      </form>
      @if (errorMessage) {
        <div class="error-msg">{{ errorMessage }}</div>
      }
    </section>

    <!-- Tables list -->
    @if (isLoading) {
      <div class="loading">Chargement...</div>
    }

    @if (!isLoading && tables.length === 0) {
      <div class="empty">Aucune table cr√©√©e.</div>
    }

    @for (table of tables; track table.id) {
      <section class="table-card">
        <!-- Confirm delete overlay -->
        @if (confirmDeleteId === table.id) {
          <div class="delete-confirm">
            <p>Supprimer la table #{{ table.number }} ?</p>
            <div class="delete-confirm-actions">
              <button class="action-btn danger" (click)="confirmDelete(table)" [disabled]="deletingTableId === table.id">
                {{ deletingTableId === table.id ? '...' : 'üóë Confirmer' }}
              </button>
              <button class="action-btn" (click)="cancelDelete()">Annuler</button>
            </div>
          </div>
        }

        <!-- Edit mode -->
        @if (editingTableId === table.id) {
          <div class="edit-form">
            <h4>Modifier la table #{{ table.number }}</h4>
            <div class="form-row">
              <div class="field">
                <label>Num√©ro</label>
                <input type="number" min="1" [(ngModel)]="editNumber" />
              </div>
              <div class="field">
                <label>Capacit√©</label>
                <input type="number" min="1" max="20" [(ngModel)]="editCapacity" />
              </div>
            </div>
            @if (editErrorMessage) {
              <div class="error-msg">{{ editErrorMessage }}</div>
            }
            <div class="edit-actions">
              <button class="action-btn save-btn" (click)="saveEdit()" [disabled]="isUpdating || !editNumber || !editCapacity">
                {{ isUpdating ? '...' : 'üíæ Sauvegarder' }}
              </button>
              <button class="action-btn" (click)="cancelEdit()">Annuler</button>
            </div>
          </div>
        } @else {
          <!-- Normal display -->
          <div class="table-top-row">
            <div class="table-info">
              <div class="table-number">Table #{{ table.number }}</div>
              <div class="table-meta">
                <span class="badge capacity">{{ table.capacity }} places</span>
                <span class="badge" [class.available]="table.status === 'available'" [class.occupied]="table.status === 'occupied'">
                  {{ table.status === 'available' ? 'Disponible' : table.status === 'occupied' ? 'Occup√©e' : table.status }}
                </span>
              </div>
            </div>
            <div class="qr-container" [id]="'qr-' + table.qr_token"></div>
          </div>

          <div class="table-url">
            <code class="url-text">{{ getTableUrl(table) }}</code>
          </div>

          <div class="table-actions">
            <button class="action-btn" (click)="copyUrl(table)">
              {{ copiedToken === table.qr_token ? '‚úì Copi√©!' : 'üìã Copier' }}
            </button>
            <button class="action-btn" (click)="downloadQr(table, 'svg')">‚¨á SVG</button>
            <button class="action-btn" (click)="downloadQr(table, 'png')">‚¨á PNG</button>
            <button class="action-btn edit-btn" (click)="startEdit(table)">‚úèÔ∏è Modifier</button>
            <button class="action-btn danger" (click)="askDelete(table)">üóë Supprimer</button>
          </div>
        }
      </section>
    }
  </div>
</main>
